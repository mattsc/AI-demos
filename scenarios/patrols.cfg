#textdomain wesnoth

[scenario]
    id=patrols
    name=_"Patrols"
    next_scenario=micro_ai_test

    map_data="{multiplayer/maps/2p_Sullas_Ruins.map}"

    {DEFAULT_SCHEDULE}
    turns=-1
    victory_when_enemies_defeated=no

    [side]
        side=1
        controller=human
        id=Gertburt
        name=_"Gertburt"
        unrenamable=yes
        type=Outlaw
        x,y=13,8

        persistent=no

        team_name=bandits
        user_team_name=_"Bandits"
        recruit=Ruffian,Footpad,Thug,Poacher

        gold=200
    [/side]

    # Patrol AI
    [side]
        side=2
        controller=ai
        no_leader=yes
        persistent=no

        team_name=Konrad
        user_team_name=_"Konrad"

        gold=0
        income=-2

        {MICRO_AI_PATROL}
    [/side]

    # Urudin's side
    # This is taken almost literally from 'Ka'lian under Attack' in 'Legend of Wesmere'
    [side]
        side=3
        controller=ai
        no_leader=yes
        persistent=no
        team_name=Urudin
        user_team_name=_"Urudin"
        gold=0
        recruit=""
        [ai]
            version=10703
            [engine]
                name=lua
                code= <<
                    local ai = ...
                    return wesnoth.require("~add-ons/AI-demos/lua/urudin_engine.lua").init(ai)
                >>
            [/engine]
            [stage]
                id=leader_retreat
                engine=lua
                name=leader_retreat
                #retreat on > half HP lost  or turn>=3
                code="(...):retreat()"
            [/stage]
            [stage]
                name=testing_ai_default::candidate_action_evaluation_loop
                id=simple_main_loop
                {AI_CA_COMBAT}
                {AI_CA_SIMPLE_MOVE_TO_TARGETS}
            [/stage]
        [/ai]
    [/side]

    # Put all the patrol units and labels/items out there
    [event]
        name=prestart
        [unit]
            type=Spearman
            side=2
            id=Konrad
            name=_"Konrad"
            x,y=5,7
            random_traits=no
        [/unit]
        [unit]
            type=Longbowman
            side=2
            id=patrol1
            random_traits=no
            x,y=14,12
        [/unit]
        [unit]
            type=Swordsman
            side=2
            id=patrol2
            random_traits=no
            x,y=17,12
        [/unit]

        [unit]
            type="Orcish Slayer"
            id=Urudin
            name= _ "Urudin"
            side=3
            x,y=22,4
        [/unit]

        [micro_ai]
            # Required keys of [micro_ai] tag
            side=2
            ai_type=patrol_unit
            action=add

            id=Konrad
            waypoint_x=9,24,25
            waypoint_y=21,23,15
            one_time_only=yes
        [/micro_ai]

        [micro_ai]
            # Required keys of [micro_ai] tag
            side=2
            ai_type=patrol_unit
            action=add

            id=patrol1
            waypoint_x=14,14,22,22
            waypoint_y=12,19,18,12
            attack=xxxx # don't attack anybody
            out_and_back=yes
        [/micro_ai]

        [micro_ai]
            # Required keys of [micro_ai] tag
            side=2
            ai_type=patrol_unit
            action=add

            id=patrol2
            waypoint_x=14,14,22,22
            waypoint_y=12,19,18,12
            attack=xxxx # don't attack anybody
        [/micro_ai]


        {PLACE_IMAGE "scenery/signpost.png" 11 4}
        {SET_LABEL 11 4 _"End Scenario"}

        {PLACE_IMAGE "scenery/signpost.png" 9 21}
        {SET_LABEL 9 21 _"Konrad Waypoint 1"}
        {PLACE_IMAGE "scenery/signpost.png" 24 23}
        {SET_LABEL 24 23 _"Konrad Waypoint 2"}
        {PLACE_IMAGE "scenery/signpost.png" 25 15}
        {SET_LABEL 25 15 _"Konrad Final Waypoint"}

        {PLACE_IMAGE "scenery/signpost.png" 14 12}
        {SET_LABEL 14 12 _"Patrol Waypoint 1"}
        {PLACE_IMAGE "scenery/signpost.png" 14 19}
        {SET_LABEL 14 19 _"Patrol Waypoint 2"}
        {PLACE_IMAGE "scenery/signpost.png" 22 18}
        {SET_LABEL 22 18 _"Patrol Waypoint 3"}
        {PLACE_IMAGE "scenery/signpost.png" 22 12}
        {SET_LABEL 22 12 _"Patrol Waypoint 4"}

        {PLACE_IMAGE "scenery/signpost.png" 33 8}
        {SET_LABEL 35 7 _"Urudin retreats here"}
    [/event]

    [event]
        name=start

        {STORE_UNIT_VAR id=Konrad profile profile}
        {MESSAGE Konrad "$profile~FL()~RIGHT()" "" _"Hello!  I'm a Konrad impostor.  I am on my way to the south-east corner of the map, by route of a couple waypoints.  I head there without distractions, except when I am injured by an enemy, in which case I retreat to one of four pre-determined villages for healing."}
        {STORE_UNIT_VAR (id=Goblin Handler Jabb) profile profile}
        {MESSAGE (Goblin Handler Jabb) "$profile~FL()~RIGHT()" "" _"I'm Goblin Handler Jabb.  I follow a patrol route with four different waypoints.  I do nothing else unless I end up next to that thief Jacques.  In that case I attack him.

Note: The Jabb Patrol AI is coded as a Micro AI.  A Micro AI can be added and adapted to the need of a scenario easily using only WML and the [micro_ai] tag.  Check out the <span color='#00A000'>Micro AI wiki page</span> at http://wiki.wesnoth.org/Micro_AIs for more information."}
        {STORE_UNIT_VAR id=Jacques profile profile}
        {MESSAGE Jacques "$profile~FL()~RIGHT()" "" _"Hah, we'll see about that!
Note to player: you can move me around to see if Jabb really dares to attack me."}
        {MESSAGE Urudin "" "" _"And I am Urudin.  I will attack my enemies for a few turns, but will retreat toward the right edge of the map if my hitpoints are below half of maximum or by Turn 5, whatever happens first"}
        {CLEAR_VARIABLE profile}

        [objectives]
            summary=_"Watch the patrols, attack them etc."
            [objective]
                description=_"Defeat all enemy units"
                condition=win
            [/objective]
            [objective]
                description=_"Move Gertburt to the signpost"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Gertburt"
                condition=lose
            [/objective]
        [/objectives]
    [/event]

    # When Konrad gets to the end of his route, display a message
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Konrad
            x,y=25,15
        [/filter]

        {MESSAGE Konrad "" "" _"That was fun!  I'll just hang out here now."}
    [/event]

    # The events finishing the scenario
    [event]
        name=die
        first_time_only=no

        [if]
            [not]
                [have_unit]
                    side=2,3
                [/have_unit]
            [/not]
            [then]
                [kill]
                    id=$unit.id
                [/kill]

                [fire_event]
                    name=end_scenario
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Gertburt
            x,y=20,3
        [/filter]

        [fire_event]
            name=end_scenario
        [/fire_event]
    [/event]

    [event]
        name=end_scenario

        {MESSAGE Gertburt "" "" _"Let's go home, chaps."}

        [endlevel]
            result=victory
            bonus=no
            carryover_percentage=0
            carryover_report=no
            linger_mode=no
        [/endlevel]
    [/event]
[/scenario]
